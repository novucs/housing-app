"use strict";
/*

address
- don't look at other property values not within a quarter of a mile

detached 0.9

house size sq feet 0.6
# rooms 0.6
# bedrooms 0.6

energy rating 0.3
garage 0.3

sale price
date of sale
- every 3 months, add 3%

 */
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var geolocation = require("nativescript-geolocation");
var nativescript_angular_1 = require("nativescript-angular");
var fileSystem = require("file-system");
var EvaluateComponent = (function () {
    function EvaluateComponent(routerExtensions) {
        this.routerExtensions = routerExtensions;
        this.property = {
            location: undefined,
            detached: false,
            size: undefined,
            rooms: undefined,
            bedrooms: undefined,
            energyRating: undefined,
            garage: false,
            salePrice: undefined,
            saleDate: new Date()
        };
    }
    EvaluateComponent_1 = EvaluateComponent;
    EvaluateComponent.prototype.back = function () {
        this.routerExtensions.navigate(["/index"], { clearHistory: true });
    };
    EvaluateComponent.prototype.parse = function (text) {
        return parseInt(text);
    };
    EvaluateComponent.prototype.submit = function () {
        var _this = this;
        console.log(JSON.stringify(this.property, null, 2));
        if (!this.property.size ||
            !this.property.rooms ||
            !this.property.bedrooms ||
            !this.property.energyRating) {
            alert("You have not filled in all required fields!");
            return;
        }
        while (!geolocation.isEnabled()) {
            geolocation.enableLocationRequest(true);
        }
        var soldFile = fileSystem.knownFolders.currentApp().getFile("sold.json");
        geolocation.getCurrentLocation({}).then(function (location) {
            _this.property.location = location;
            return soldFile.readText();
        }).then(function (content) {
            var soldProperties = [];
            if (content) {
                soldProperties = JSON.parse(content);
            }
            var nearbyProperties = [];
            var min = JSON.parse(JSON.stringify(_this.property));
            var max = JSON.parse(JSON.stringify(_this.property));
            soldProperties.forEach(function (property) {
                var distance = EvaluateComponent_1.distance(property.location, _this.property.location);
                if (distance < 0.25) {
                    nearbyProperties.push(property);
                    for (var key in property) {
                        if (property.hasOwnProperty(key) &&
                            _this.property.hasOwnProperty(key)) {
                            if (property[key] > max[key]) {
                                max[key] = property[key];
                            }
                            if (property[key] < min[key]) {
                                min[key] = property[key];
                            }
                        }
                    }
                }
            });
            if (nearbyProperties.length <= 0) {
                alert("Cannot evaluate house value. No other properties sold in this region have been tracked.");
                return;
            }
            var closest = null;
            var closestValue = 0;
            for (var key in _this.property) {
                if (_this.property.hasOwnProperty(key) &&
                    key.indexOf("Scaled") < 0 &&
                    typeof _this.property[key] == "number") {
                    _this.property[key + "Scaled"] = (_this.property[key] - min[key]) / (max[key] - min[key]);
                }
            }
            var modifiers = {
                detached: 0.9,
                size: 0.6,
                rooms: 0.6,
                bedrooms: 0.6,
                energyRating: 0.3,
                garage: 0.3
            };
            console.log("\n\n-------------------------");
            console.log("\nBEGINNING EVALUATION\n\n");
            console.log("-------------------------\n\n");
            var id = 0;
            nearbyProperties.forEach(function (property) {
                // feature scaling
                for (var key in property) {
                    if (property.hasOwnProperty(key) &&
                        _this.property.hasOwnProperty(key) &&
                        key.indexOf("Scaled") < 0 &&
                        typeof property[key] == "number") {
                        property[key + "Scaled"] = (property[key] - min[key]) / (max[key] - min[key]);
                    }
                }
                var weights = {
                    detached: property.detached == _this.property.detached ? 0 : modifiers.detached,
                    size: Math.sqrt(Math.pow(property.sizeScaled - _this.property["sizeScaled"], 2)) * modifiers.size,
                    rooms: Math.sqrt(Math.pow(property.roomsScaled - _this.property["roomsScaled"], 2)) * modifiers.rooms,
                    bedrooms: Math.sqrt(Math.pow(property.bedroomsScaled - _this.property["bedroomsScaled"], 2)) * modifiers.bedrooms,
                    energyRating: Math.sqrt(Math.pow(property.energyRatingScaled - _this.property["energyRatingScaled"], 2)) * modifiers.energyRating,
                    garage: property.garage == _this.property.garage ? 0 : modifiers.garage
                };
                var value = weights.detached + weights.size + weights.rooms + weights.bedrooms + weights.energyRating + weights.garage;
                console.log("WEIGHTS (" + id++ + "): " + JSON.stringify(weights, null, 2));
                console.log("OVERALL VALUE: " + value + "\n\n");
                if (closest == null || closestValue > value) {
                    closestValue = value;
                    closest = property;
                }
            });
            var price = closest.salePrice;
            var monthDiff = EvaluateComponent_1.monthDiff(new Date(closest.saleDate), _this.property.saleDate);
            console.log(price + "  " + (monthDiff / 3));
            price += price * (monthDiff / 3);
            console.log(price);
            _this.property.salePrice = price;
            alert("The predicted price of your property is: \n$" + price);
        });
    };
    EvaluateComponent.distance = function (loc1, loc2) {
        var lat1 = loc1.latitude;
        var lon1 = loc1.longitude;
        var lat2 = loc2.latitude;
        var lon2 = loc2.longitude;
        var p = 0.017453292519943295;
        var c = Math.cos;
        var a = 0.5 - c((lat2 - lat1) * p) / 2 +
            c(lat1 * p) * c(lat2 * p) *
                (1 - c((lon2 - lon1) * p)) / 2;
        return 7917.509282 * Math.asin(Math.sqrt(a));
    };
    EvaluateComponent.monthDiff = function (d1, d2) {
        var months;
        months = (d2.getFullYear() - d1.getFullYear()) * 12;
        months -= d1.getMonth() + 1;
        months += d2.getMonth();
        return months <= 0 ? 0 : months;
    };
    EvaluateComponent = EvaluateComponent_1 = __decorate([
        core_1.Component({
            templateUrl: "./evaluate.component.html"
        }),
        __metadata("design:paramtypes", [nativescript_angular_1.RouterExtensions])
    ], EvaluateComponent);
    return EvaluateComponent;
    var EvaluateComponent_1;
}());
exports.EvaluateComponent = EvaluateComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZhbHVhdGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXZhbHVhdGUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBa0JHOztBQUVILHNDQUF3QztBQUN4QyxzREFBd0Q7QUFDeEQsNkRBQXNEO0FBQ3RELHdDQUEwQztBQU0xQztJQWNJLDJCQUFvQixnQkFBa0M7UUFBbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQVp0RCxhQUFRLEdBQWlCO1lBQ3JCLFFBQVEsRUFBRSxTQUFTO1lBQ25CLFFBQVEsRUFBRSxLQUFLO1lBQ2YsSUFBSSxFQUFFLFNBQVM7WUFDZixLQUFLLEVBQUUsU0FBUztZQUNoQixRQUFRLEVBQUUsU0FBUztZQUNuQixZQUFZLEVBQUUsU0FBUztZQUN2QixNQUFNLEVBQUUsS0FBSztZQUNiLFNBQVMsRUFBRSxTQUFTO1lBQ3BCLFFBQVEsRUFBRSxJQUFJLElBQUksRUFBRTtTQUN2QixDQUFDO0lBR0YsQ0FBQzswQkFmUSxpQkFBaUI7SUFpQjFCLGdDQUFJLEdBQUo7UUFDSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBQyxZQUFZLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRUQsaUNBQUssR0FBTCxVQUFNLElBQUk7UUFDTixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxrQ0FBTSxHQUFOO1FBQUEsaUJBd0hDO1FBdkhHLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BELEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJO1lBQ25CLENBQUMsSUFBSSxDQUFDLFFB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LElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRU0sMkJBQVMsR0FBaEIsVUFBaUIsRUFBUSxFQUFFLEVBQVE7UUFDL0IsSUFBSSxNQUFNLENBQUM7UUFDWCxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFLEdBQUcsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3BELE1BQU0sSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzVCLE1BQU0sSUFBSSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDeEIsTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQztJQUNwQyxDQUFDO0lBdEtRLGlCQUFpQjtRQUg3QixnQkFBUyxDQUFDO1lBQ1AsV0FBVyxFQUFFLDJCQUEyQjtTQUMzQyxDQUFDO3lDQWV3Qyx1Q0FBZ0I7T0FkN0MsaUJBQWlCLENBdUs3QjtJQUFELHdCQUFDOztDQUFBLEFBdktELElBdUtDO0FBdktZLDhDQUFpQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5cbmFkZHJlc3Ncbi0gZG9uJ3QgbG9vayBhdCBvdGhlciBwcm9wZXJ0eSB2YWx1ZXMgbm90IHdpdGhpbiBhIHF1YXJ0ZXIgb2YgYSBtaWxlXG5cbmRldGFjaGVkIDAuOVxuXG5ob3VzZSBzaXplIHNxIGZlZXQgMC42XG4jIHJvb21zIDAuNlxuIyBiZWRyb29tcyAwLjZcblxuZW5lcmd5IHJhdGluZyAwLjNcbmdhcmFnZSAwLjNcblxuc2FsZSBwcmljZVxuZGF0ZSBvZiBzYWxlXG4tIGV2ZXJ5IDMgbW9udGhzLCBhZGQgMyVcblxuICovXG5cbmltcG9ydCB7Q29tcG9uZW50fSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0ICogYXMgZ2VvbG9jYXRpb24gZnJvbSBcIm5hdGl2ZXNjcmlwdC1nZW9sb2NhdGlvblwiO1xuaW1wb3J0IHtSb3V0ZXJFeHRlbnNpb25zfSBmcm9tIFwibmF0aXZlc2NyaXB0LWFuZ3VsYXJcIjtcbmltcG9ydCAqIGFzIGZpbGVTeXN0ZW0gZnJvbSBcImZpbGUtc3lzdGVtXCI7XG5pbXBvcnQge1NvbGRQcm9wZXJ0eX0gZnJvbSBcIi4vcHJvcGVydHlcIjtcblxuQENvbXBvbmVudCh7XG4gICAgdGVtcGxhdGVVcmw6IFwiLi9ldmFsdWF0ZS5jb21wb25lbnQuaHRtbFwiXG59KVxuZXhwb3J0IGNsYXNzIEV2YWx1YXRlQ29tcG9uZW50IHtcblxuICAgIHByb3BlcnR5OiBTb2xkUHJvcGVydHkgPSB7XG4gICAgICAgIGxvY2F0aW9uOiB1bmRlZmluZWQsXG4gICAgICAgIGRldGFjaGVkOiBmYWxzZSxcbiAgICAgICAgc2l6ZTogdW5kZWZpbmVkLFxuICAgICAgICByb29tczogdW5kZWZpbmVkLFxuICAgICAgICBiZWRyb29tczogdW5kZWZpbmVkLFxuICAgICAgICBlbmVyZ3lSYXRpbmc6IHVuZGVmaW5lZCxcbiAgICAgICAgZ2FyYWdlOiBmYWxzZSxcbiAgICAgICAgc2FsZVByaWNlOiB1bmRlZmluZWQsXG4gICAgICAgIHNhbGVEYXRlOiBuZXcgRGF0ZSgpXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcm91dGVyRXh0ZW5zaW9uczogUm91dGVyRXh0ZW5zaW9ucykge1xuICAgIH1cblxuICAgIGJhY2soKSB7XG4gICAgICAgIHRoaXMucm91dGVyRXh0ZW5zaW9ucy5uYXZpZ2F0ZShbXCIvaW5kZXhcIl0sIHtjbGVhckhpc3Rvcnk6IHRydWV9KTtcbiAgICB9XG5cbiAgICBwYXJzZSh0ZXh0KSB7XG4gICAgICAgIHJldHVybiBwYXJzZUludCh0ZXh0KTtcbiAgICB9XG5cbiAgICBzdWJtaXQoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHRoaXMucHJvcGVydHksIG51bGwsIDIpKTtcbiAgICAgICAgaWYgKCF0aGlzLnByb3BlcnR5LnNpemUgfHxcbiAgICAgICAgICAgICF0aGlzLnByb3BlcnR5LnJvb21zIHx8XG4gICAgICAgICAgICAhdGhpcy5wcm9wZXJ0eS5iZWRyb29tcyB8fFxuICAgICAgICAgICAgIXRoaXMucHJvcGVydHkuZW5lcmd5UmF0aW5nKSB7XG4gICAgICAgICAgICBhbGVydChcIllvdSBoYXZlIG5vdCBmaWxsZWQgaW4gYWxsIHJlcXVpcmVkIGZpZWxkcyFcIik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB3aGlsZSAoIWdlb2xvY2F0aW9uLmlzRW5hYmxlZCgpKSB7XG4gICAgICAgICAgICBnZW9sb2NhdGlvbi5lbmFibGVMb2NhdGlvblJlcXVlc3QodHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgc29sZEZpbGUgPSBmaWxlU3lzdGVtLmtub3duRm9sZGVycy5jdXJyZW50QXBwKCkuZ2V0RmlsZShcInNvbGQuanNvblwiKTtcblxuICAgICAgICBnZW9sb2NhdGlvbi5nZXRDdXJyZW50TG9jYXRpb24oe30pLnRoZW4obG9jYXRpb24gPT4ge1xuICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eS5sb2NhdGlvbiA9IGxvY2F0aW9uO1xuICAgICAgICAgICAgcmV0dXJuIHNvbGRGaWxlLnJlYWRUZXh0KCk7XG4gICAgICAgIH0pLnRoZW4oY29udGVudCA9PiB7XG4gICAgICAgICAgICBsZXQgc29sZFByb3BlcnRpZXMgPSBbXTtcblxuICAgICAgICAgICAgaWYgKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICBzb2xkUHJvcGVydGllcyA9IEpTT04ucGFyc2UoY29udGVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBuZWFyYnlQcm9wZXJ0aWVzID0gW107XG4gICAgICAgICAgICBsZXQgbWluID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLnByb3BlcnR5KSk7XG4gICAgICAgICAgICBsZXQgbWF4ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLnByb3BlcnR5KSk7XG5cbiAgICAgICAgICAgIHNvbGRQcm9wZXJ0aWVzLmZvckVhY2gocHJvcGVydHkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBkaXN0YW5jZSA9IEV2YWx1YXRlQ29tcG9uZW50LmRpc3RhbmNlKHByb3BlcnR5LmxvY2F0aW9uLCB0aGlzLnByb3BlcnR5LmxvY2F0aW9uKTtcbiAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UgPCAwLjI1KSB7XG4gICAgICAgICAgICAgICAgICAgIG5lYXJieVByb3BlcnRpZXMucHVzaChwcm9wZXJ0eSk7XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGVydHkuaGFzT3duUHJvcGVydHkoa2V5KSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvcGVydHkuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eVtrZXldID4gbWF4W2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4W2tleV0gPSBwcm9wZXJ0eVtrZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eVtrZXldIDwgbWluW2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluW2tleV0gPSBwcm9wZXJ0eVtrZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAobmVhcmJ5UHJvcGVydGllcy5sZW5ndGggPD0gMCkge1xuICAgICAgICAgICAgICAgIGFsZXJ0KFwiQ2Fubm90IGV2YWx1YXRlIGhvdXNlIHZhbHVlLiBObyBvdGhlciBwcm9wZXJ0aWVzIHNvbGQgaW4gdGhpcyByZWdpb24gaGF2ZSBiZWVuIHRyYWNrZWQuXCIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IGNsb3Nlc3Q6IFNvbGRQcm9wZXJ0eSA9IG51bGw7XG4gICAgICAgICAgICBsZXQgY2xvc2VzdFZhbHVlID0gMDtcblxuICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHRoaXMucHJvcGVydHkpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5wcm9wZXJ0eS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmXG4gICAgICAgICAgICAgICAgICAgIGtleS5pbmRleE9mKFwiU2NhbGVkXCIpIDwgMCAmJlxuICAgICAgICAgICAgICAgICAgICB0eXBlb2YgdGhpcy5wcm9wZXJ0eVtrZXldID09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eVtrZXkgKyBcIlNjYWxlZFwiXSA9ICh0aGlzLnByb3BlcnR5W2tleV0gLSBtaW5ba2V5XSkgLyAobWF4W2tleV0gLSBtaW5ba2V5XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgbW9kaWZpZXJzID0ge1xuICAgICAgICAgICAgICAgIGRldGFjaGVkOiAwLjksXG4gICAgICAgICAgICAgICAgc2l6ZTogMC42LFxuICAgICAgICAgICAgICAgIHJvb21zOiAwLjYsXG4gICAgICAgICAgICAgICAgYmVkcm9vbXM6IDAuNixcbiAgICAgICAgICAgICAgICBlbmVyZ3lSYXRpbmc6IDAuMyxcbiAgICAgICAgICAgICAgICBnYXJhZ2U6IDAuM1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJcXG5cXG4tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXCIpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJcXG5CRUdJTk5JTkcgRVZBTFVBVElPTlxcblxcblwiKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxcblxcblwiKTtcbiAgICAgICAgICAgIGxldCBpZCA9IDA7XG5cbiAgICAgICAgICAgIG5lYXJieVByb3BlcnRpZXMuZm9yRWFjaChwcm9wZXJ0eSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gZmVhdHVyZSBzY2FsaW5nXG4gICAgICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHByb3BlcnR5KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5Lmhhc093blByb3BlcnR5KGtleSkgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleS5pbmRleE9mKFwiU2NhbGVkXCIpIDwgMCAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mIHByb3BlcnR5W2tleV0gPT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlba2V5ICsgXCJTY2FsZWRcIl0gPSAocHJvcGVydHlba2V5XSAtIG1pbltrZXldKSAvIChtYXhba2V5XSAtIG1pbltrZXldKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICAgICAgbGV0IHdlaWdodHMgPSB7XG4gICAgICAgICAgICAgICAgICAgIGRldGFjaGVkOiBwcm9wZXJ0eS5kZXRhY2hlZCA9PSB0aGlzLnByb3BlcnR5LmRldGFjaGVkID8gMCA6IG1vZGlmaWVycy5kZXRhY2hlZCxcbiAgICAgICAgICAgICAgICAgICAgc2l6ZTogTWF0aC5zcXJ0KE1hdGgucG93KHByb3BlcnR5LnNpemVTY2FsZWQgLSB0aGlzLnByb3BlcnR5W1wic2l6ZVNjYWxlZFwiXSwgMikpICogbW9kaWZpZXJzLnNpemUsXG4gICAgICAgICAgICAgICAgICAgIHJvb21zOiBNYXRoLnNxcnQoTWF0aC5wb3cocHJvcGVydHkucm9vbXNTY2FsZWQgLSB0aGlzLnByb3BlcnR5W1wicm9vbXNTY2FsZWRcIl0sIDIpKSAqIG1vZGlmaWVycy5yb29tcyxcbiAgICAgICAgICAgICAgICAgICAgYmVkcm9vbXM6IE1hdGguc3FydChNYXRoLnBvdyhwcm9wZXJ0eS5iZWRyb29tc1NjYWxlZCAtIHRoaXMucHJvcGVydHlbXCJiZWRyb29tc1NjYWxlZFwiXSwgMikpICogbW9kaWZpZXJzLmJlZHJvb21zLFxuICAgICAgICAgICAgICAgICAgICBlbmVyZ3lSYXRpbmc6IE1hdGguc3FydChNYXRoLnBvdyhwcm9wZXJ0eS5lbmVyZ3lSYXRpbmdTY2FsZWQgLSB0aGlzLnByb3BlcnR5W1wiZW5lcmd5UmF0aW5nU2NhbGVkXCJdLCAyKSkgKiBtb2RpZmllcnMuZW5lcmd5UmF0aW5nLFxuICAgICAgICAgICAgICAgICAgICBnYXJhZ2U6IHByb3BlcnR5LmdhcmFnZSA9PSB0aGlzLnByb3BlcnR5LmdhcmFnZSA/IDAgOiBtb2RpZmllcnMuZ2FyYWdlXG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IHdlaWdodHMuZGV0YWNoZWQgKyB3ZWlnaHRzLnNpemUgKyB3ZWlnaHRzLnJvb21zICsgd2VpZ2h0cy5iZWRyb29tcyArIHdlaWdodHMuZW5lcmd5UmF0aW5nICsgd2VpZ2h0cy5nYXJhZ2U7XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIldFSUdIVFMgKFwiICsgaWQrKyArIFwiKTogXCIgKyBKU09OLnN0cmluZ2lmeSh3ZWlnaHRzLCBudWxsLCAyKSk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJPVkVSQUxMIFZBTFVFOiBcIiArIHZhbHVlICsgXCJcXG5cXG5cIik7XG5cbiAgICAgICAgICAgICAgICBpZiAoY2xvc2VzdCA9PSBudWxsIHx8IGNsb3Nlc3RWYWx1ZSA+IHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsb3Nlc3RWYWx1ZSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICBjbG9zZXN0ID0gcHJvcGVydHk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGxldCBwcmljZSA9IGNsb3Nlc3Quc2FsZVByaWNlO1xuICAgICAgICAgICAgbGV0IG1vbnRoRGlmZiA9IEV2YWx1YXRlQ29tcG9uZW50Lm1vbnRoRGlmZihuZXcgRGF0ZShjbG9zZXN0LnNhbGVEYXRlKSwgdGhpcy5wcm9wZXJ0eS5zYWxlRGF0ZSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhwcmljZSArIFwiICBcIiArIChtb250aERpZmYgLyAzKSk7XG4gICAgICAgICAgICBwcmljZSArPSBwcmljZSAqIChtb250aERpZmYgLyAzKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHByaWNlKTtcbiAgICAgICAgICAgIHRoaXMucHJvcGVydHkuc2FsZVByaWNlID0gcHJpY2U7XG4gICAgICAgICAgICBhbGVydChcIlRoZSBwcmVkaWN0ZWQgcHJpY2Ugb2YgeW91ciBwcm9wZXJ0eSBpczogXFxuJFwiICsgcHJpY2UpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZGlzdGFuY2UobG9jMSwgbG9jMikge1xuICAgICAgICBsZXQgbGF0MSA9IGxvYzEubGF0aXR1ZGU7XG4gICAgICAgIGxldCBsb24xID0gbG9jMS5sb25naXR1ZGU7XG4gICAgICAgIGxldCBsYXQyID0gbG9jMi5sYXRpdHVkZTtcbiAgICAgICAgbGV0IGxvbjIgPSBsb2MyLmxvbmdpdHVkZTtcbiAgICAgICAgbGV0IHAgPSAwLjAxNzQ1MzI5MjUxOTk0MzI5NTtcbiAgICAgICAgbGV0IGMgPSBNYXRoLmNvcztcbiAgICAgICAgbGV0IGEgPSAwLjUgLSBjKChsYXQyIC0gbGF0MSkgKiBwKSAvIDIgK1xuICAgICAgICAgICAgYyhsYXQxICogcCkgKiBjKGxhdDIgKiBwKSAqXG4gICAgICAgICAgICAoMSAtIGMoKGxvbjIgLSBsb24xKSAqIHApKSAvIDI7XG4gICAgICAgIHJldHVybiA3OTE3LjUwOTI4MiAqIE1hdGguYXNpbihNYXRoLnNxcnQoYSkpO1xuICAgIH1cblxuICAgIHN0YXRpYyBtb250aERpZmYoZDE6IERhdGUsIGQyOiBEYXRlKSB7XG4gICAgICAgIGxldCBtb250aHM7XG4gICAgICAgIG1vbnRocyA9IChkMi5nZXRGdWxsWWVhcigpIC0gZDEuZ2V0RnVsbFllYXIoKSkgKiAxMjtcbiAgICAgICAgbW9udGhzIC09IGQxLmdldE1vbnRoKCkgKyAxO1xuICAgICAgICBtb250aHMgKz0gZDIuZ2V0TW9udGgoKTtcbiAgICAgICAgcmV0dXJuIG1vbnRocyA8PSAwID8gMCA6IG1vbnRocztcbiAgICB9XG59XG4iXX0=