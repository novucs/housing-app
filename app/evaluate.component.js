"use strict";
/*

address
- don't look at other property values not within a quarter of a mile

detached 0.9

house size sq feet 0.6
# rooms 0.6
# bedrooms 0.6

energy rating 0.3
garage 0.3

sale price
date of sale
- every 3 months, add 3%

 */
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var geolocation = require("nativescript-geolocation");
var nativescript_angular_1 = require("nativescript-angular");
var fileSystem = require("file-system");
var EvaluateComponent = (function () {
    function EvaluateComponent(routerExtensions) {
        this.routerExtensions = routerExtensions;
        this.property = {
            location: undefined,
            detached: false,
            size: undefined,
            rooms: undefined,
            bedrooms: undefined,
            energyRating: undefined,
            garage: false,
            salePrice: undefined,
            saleDate: new Date()
        };
    }
    EvaluateComponent_1 = EvaluateComponent;
    EvaluateComponent.prototype.back = function () {
        this.routerExtensions.navigate(["/index"], { clearHistory: true });
    };
    EvaluateComponent.prototype.parse = function (text) {
        return parseInt(text);
    };
    EvaluateComponent.prototype.submit = function () {
        var _this = this;
        console.log(JSON.stringify(this.property, null, 2));
        if (!this.property.size ||
            !this.property.rooms ||
            !this.property.bedrooms ||
            !this.property.energyRating) {
            alert("You have not filled in all required fields!");
            return;
        }
        while (!geolocation.isEnabled()) {
            geolocation.enableLocationRequest(true);
        }
        var soldFile = fileSystem.knownFolders.currentApp().getFile("sold.json");
        geolocation.getCurrentLocation({}).then(function (location) {
            _this.property.location = location;
            return soldFile.readText();
        }).then(function (content) {
            var soldProperties = [];
            if (content) {
                soldProperties = JSON.parse(content);
            }
            var nearbyProperties = [];
            var min = JSON.parse(JSON.stringify(_this.property));
            var max = JSON.parse(JSON.stringify(_this.property));
            soldProperties.forEach(function (property) {
                var distance = EvaluateComponent_1.distance(property.location, _this.property.location);
                if (distance < 0.25) {
                    nearbyProperties.push(property);
                    for (var key in property) {
                        if (property.hasOwnProperty(key) &&
                            _this.property.hasOwnProperty(key)) {
                            if (property[key] > max[key]) {
                                max[key] = property[key];
                            }
                            if (property[key] < min[key]) {
                                min[key] = property[key];
                            }
                        }
                    }
                }
            });
            if (nearbyProperties.length <= 0) {
                alert("Cannot evaluate house value. No other properties sold in this region have been tracked.");
                return;
            }
            var closest = null;
            var closestValue = 0;
            for (var key in _this.property) {
                if (_this.property.hasOwnProperty(key) &&
                    key.indexOf("Scaled") < 0 &&
                    typeof _this.property[key] == "number") {
                    _this.property[key + "Scaled"] = (_this.property[key] - min[key]) / (max[key] - min[key]);
                }
            }
            var modifiers = {
                detached: 0.9,
                size: 0.6,
                rooms: 0.6,
                bedrooms: 0.6,
                energyRating: 0.3,
                garage: 0.3
            };
            console.log("\n\n-------------------------");
            console.log("\nBEGINNING EVALUATION\n\n");
            console.log("-------------------------\n\n");
            var id = 0;
            nearbyProperties.forEach(function (property) {
                // feature scaling
                for (var key in property) {
                    if (property.hasOwnProperty(key) &&
                        _this.property.hasOwnProperty(key) &&
                        key.indexOf("Scaled") < 0 &&
                        typeof property[key] == "number") {
                        property[key + "Scaled"] = (property[key] - min[key]) / (max[key] - min[key]);
                    }
                }
                var weights = {
                    detached: property.detached == _this.property.detached ? 0 : modifiers.detached,
                    size: Math.sqrt(Math.pow(property.sizeScaled - _this.property["sizeScaled"], 2)) * modifiers.size,
                    rooms: Math.sqrt(Math.pow(property.roomsScaled - _this.property["roomsScaled"], 2)) * modifiers.rooms,
                    bedrooms: Math.sqrt(Math.pow(property.bedroomsScaled - _this.property["bedroomsScaled"], 2)) * modifiers.bedrooms,
                    energyRating: Math.sqrt(Math.pow(property.energyRatingScaled - _this.property["energyRatingScaled"], 2)) * modifiers.energyRating,
                    garage: property.garage == _this.property.garage ? 0 : modifiers.garage
                };
                var value = weights.detached + weights.size + weights.rooms + weights.bedrooms + weights.energyRating + weights.garage;
                console.log("WEIGHTS (" + id++ + "): " + JSON.stringify(weights, null, 2));
                console.log("OVERALL VALUE: " + value + "\n\n");
                if (closest == null || closestValue > value) {
                    closestValue = value;
                    closest = property;
                }
            });
            var monthDiff = EvaluateComponent_1.monthDiff(new Date(closest.saleDate), _this.property.saleDate);
            var price = closest.salePrice * Math.pow(1.03, monthDiff);
            _this.property.salePrice = price;
            alert("The predicted price of your property is: \n$" + price);
        });
    };
    EvaluateComponent.distance = function (loc1, loc2) {
        var lat1 = loc1.latitude;
        var lon1 = loc1.longitude;
        var lat2 = loc2.latitude;
        var lon2 = loc2.longitude;
        var p = 0.017453292519943295;
        var c = Math.cos;
        var a = 0.5 - c((lat2 - lat1) * p) / 2 +
            c(lat1 * p) * c(lat2 * p) *
                (1 - c((lon2 - lon1) * p)) / 2;
        return 7917.509282 * Math.asin(Math.sqrt(a));
    };
    EvaluateComponent.monthDiff = function (d1, d2) {
        var months;
        months = (d2.getFullYear() - d1.getFullYear()) * 12;
        months -= d1.getMonth() + 1;
        months += d2.getMonth();
        return months <= 0 ? 0 : months;
    };
    EvaluateComponent = EvaluateComponent_1 = __decorate([
        core_1.Component({
            templateUrl: "./evaluate.component.html"
        }),
        __metadata("design:paramtypes", [nativescript_angular_1.RouterExtensions])
    ], EvaluateComponent);
    return EvaluateComponent;
    var EvaluateComponent_1;
}());
exports.EvaluateComponent = EvaluateComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZhbHVhdGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXZhbHVhdGUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBa0JHOztBQUVILHNDQUF3QztBQUN4QyxzREFBd0Q7QUFDeEQsNkRBQXNEO0FBQ3RELHdDQUEwQztBQU0xQztJQWNJLDJCQUFvQixnQkFBa0M7UUFBbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQVp0RCxhQUFRLEdBQWlCO1lBQ3JCLFFBQVEsRUFBRSxTQUFTO1lBQ25CLFFBQVEsRUFBRSxLQUFLO1lBQ2YsSUFBSSxFQUFFLFNBQVM7WUFDZixLQUFLLEVBQUUsU0FBUztZQUNoQixRQUFRLEVBQUUsU0FBUztZQUNuQixZQUFZLEVBQUUsU0FBUztZQUN2QixNQUFNLEVBQUUsS0FBSztZQUNiLFNBQVMsRUFBRSxTQUFTO1lBQ3BCLFFBQVEsRUFBRSxJQUFJLElBQUksRUFBRTtTQUN2QixDQUFDO0lBR0YsQ0FBQzswQkFmUSxpQkFBaUI7SUFpQjFCLGdDQUFJLEdBQUo7UUFDSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBQyxZQUFZLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBRUQsaUNBQUssR0FBTCxVQUFNLElBQUk7UUFDTixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxrQ0FBTSxHQUFOO1FBQUEsaUJBcUhDO1FBcEhHLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BELEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJO1lBQ25CLENBQUMsSUFBSSxDQUFDLFFB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QUUsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDcEQsTUFBTSxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDNUIsTUFBTSxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN4QixNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDO0lBQ3BDLENBQUM7SUFuS1EsaUJBQWlCO1FBSDdCLGdCQUFTLENBQUM7WUFDUCxXQUFXLEVBQUUsMkJBQTJCO1NBQzNDLENBQUM7eUNBZXdDLHVDQUFnQjtPQWQ3QyxpQkFBaUIsQ0FvSzdCO0lBQUQsd0JBQUM7O0NBQUEsQUFwS0QsSUFvS0M7QUFwS1ksOENBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiLypcblxuYWRkcmVzc1xuLSBkb24ndCBsb29rIGF0IG90aGVyIHByb3BlcnR5IHZhbHVlcyBub3Qgd2l0aGluIGEgcXVhcnRlciBvZiBhIG1pbGVcblxuZGV0YWNoZWQgMC45XG5cbmhvdXNlIHNpemUgc3EgZmVldCAwLjZcbiMgcm9vbXMgMC42XG4jIGJlZHJvb21zIDAuNlxuXG5lbmVyZ3kgcmF0aW5nIDAuM1xuZ2FyYWdlIDAuM1xuXG5zYWxlIHByaWNlXG5kYXRlIG9mIHNhbGVcbi0gZXZlcnkgMyBtb250aHMsIGFkZCAzJVxuXG4gKi9cblxuaW1wb3J0IHtDb21wb25lbnR9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgKiBhcyBnZW9sb2NhdGlvbiBmcm9tIFwibmF0aXZlc2NyaXB0LWdlb2xvY2F0aW9uXCI7XG5pbXBvcnQge1JvdXRlckV4dGVuc2lvbnN9IGZyb20gXCJuYXRpdmVzY3JpcHQtYW5ndWxhclwiO1xuaW1wb3J0ICogYXMgZmlsZVN5c3RlbSBmcm9tIFwiZmlsZS1zeXN0ZW1cIjtcbmltcG9ydCB7U29sZFByb3BlcnR5fSBmcm9tIFwiLi9wcm9wZXJ0eVwiO1xuXG5AQ29tcG9uZW50KHtcbiAgICB0ZW1wbGF0ZVVybDogXCIuL2V2YWx1YXRlLmNvbXBvbmVudC5odG1sXCJcbn0pXG5leHBvcnQgY2xhc3MgRXZhbHVhdGVDb21wb25lbnQge1xuXG4gICAgcHJvcGVydHk6IFNvbGRQcm9wZXJ0eSA9IHtcbiAgICAgICAgbG9jYXRpb246IHVuZGVmaW5lZCxcbiAgICAgICAgZGV0YWNoZWQ6IGZhbHNlLFxuICAgICAgICBzaXplOiB1bmRlZmluZWQsXG4gICAgICAgIHJvb21zOiB1bmRlZmluZWQsXG4gICAgICAgIGJlZHJvb21zOiB1bmRlZmluZWQsXG4gICAgICAgIGVuZXJneVJhdGluZzogdW5kZWZpbmVkLFxuICAgICAgICBnYXJhZ2U6IGZhbHNlLFxuICAgICAgICBzYWxlUHJpY2U6IHVuZGVmaW5lZCxcbiAgICAgICAgc2FsZURhdGU6IG5ldyBEYXRlKClcbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZXJFeHRlbnNpb25zOiBSb3V0ZXJFeHRlbnNpb25zKSB7XG4gICAgfVxuXG4gICAgYmFjaygpIHtcbiAgICAgICAgdGhpcy5yb3V0ZXJFeHRlbnNpb25zLm5hdmlnYXRlKFtcIi9pbmRleFwiXSwge2NsZWFySGlzdG9yeTogdHJ1ZX0pO1xuICAgIH1cblxuICAgIHBhcnNlKHRleHQpIHtcbiAgICAgICAgcmV0dXJuIHBhcnNlSW50KHRleHQpO1xuICAgIH1cblxuICAgIHN1Ym1pdCgpIHtcbiAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkodGhpcy5wcm9wZXJ0eSwgbnVsbCwgMikpO1xuICAgICAgICBpZiAoIXRoaXMucHJvcGVydHkuc2l6ZSB8fFxuICAgICAgICAgICAgIXRoaXMucHJvcGVydHkucm9vbXMgfHxcbiAgICAgICAgICAgICF0aGlzLnByb3BlcnR5LmJlZHJvb21zIHx8XG4gICAgICAgICAgICAhdGhpcy5wcm9wZXJ0eS5lbmVyZ3lSYXRpbmcpIHtcbiAgICAgICAgICAgIGFsZXJ0KFwiWW91IGhhdmUgbm90IGZpbGxlZCBpbiBhbGwgcmVxdWlyZWQgZmllbGRzIVwiKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHdoaWxlICghZ2VvbG9jYXRpb24uaXNFbmFibGVkKCkpIHtcbiAgICAgICAgICAgIGdlb2xvY2F0aW9uLmVuYWJsZUxvY2F0aW9uUmVxdWVzdCh0cnVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBzb2xkRmlsZSA9IGZpbGVTeXN0ZW0ua25vd25Gb2xkZXJzLmN1cnJlbnRBcHAoKS5nZXRGaWxlKFwic29sZC5qc29uXCIpO1xuXG4gICAgICAgIGdlb2xvY2F0aW9uLmdldEN1cnJlbnRMb2NhdGlvbih7fSkudGhlbihsb2NhdGlvbiA9PiB7XG4gICAgICAgICAgICB0aGlzLnByb3BlcnR5LmxvY2F0aW9uID0gbG9jYXRpb247XG4gICAgICAgICAgICByZXR1cm4gc29sZEZpbGUucmVhZFRleHQoKTtcbiAgICAgICAgfSkudGhlbihjb250ZW50ID0+IHtcbiAgICAgICAgICAgIGxldCBzb2xkUHJvcGVydGllcyA9IFtdO1xuXG4gICAgICAgICAgICBpZiAoY29udGVudCkge1xuICAgICAgICAgICAgICAgIHNvbGRQcm9wZXJ0aWVzID0gSlNPTi5wYXJzZShjb250ZW50KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGV0IG5lYXJieVByb3BlcnRpZXMgPSBbXTtcbiAgICAgICAgICAgIGxldCBtaW4gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMucHJvcGVydHkpKTtcbiAgICAgICAgICAgIGxldCBtYXggPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMucHJvcGVydHkpKTtcblxuICAgICAgICAgICAgc29sZFByb3BlcnRpZXMuZm9yRWFjaChwcm9wZXJ0eSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGRpc3RhbmNlID0gRXZhbHVhdGVDb21wb25lbnQuZGlzdGFuY2UocHJvcGVydHkubG9jYXRpb24sIHRoaXMucHJvcGVydHkubG9jYXRpb24pO1xuICAgICAgICAgICAgICAgIGlmIChkaXN0YW5jZSA8IDAuMjUpIHtcbiAgICAgICAgICAgICAgICAgICAgbmVhcmJ5UHJvcGVydGllcy5wdXNoKHByb3BlcnR5KTtcblxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gcHJvcGVydHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5W2tleV0gPiBtYXhba2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhba2V5XSA9IHByb3BlcnR5W2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5W2tleV0gPCBtaW5ba2V5XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5ba2V5XSA9IHByb3BlcnR5W2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChuZWFyYnlQcm9wZXJ0aWVzLmxlbmd0aCA8PSAwKSB7XG4gICAgICAgICAgICAgICAgYWxlcnQoXCJDYW5ub3QgZXZhbHVhdGUgaG91c2UgdmFsdWUuIE5vIG90aGVyIHByb3BlcnRpZXMgc29sZCBpbiB0aGlzIHJlZ2lvbiBoYXZlIGJlZW4gdHJhY2tlZC5cIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgY2xvc2VzdDogU29sZFByb3BlcnR5ID0gbnVsbDtcbiAgICAgICAgICAgIGxldCBjbG9zZXN0VmFsdWUgPSAwO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5wcm9wZXJ0eSkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnByb3BlcnR5Lmhhc093blByb3BlcnR5KGtleSkgJiZcbiAgICAgICAgICAgICAgICAgICAga2V5LmluZGV4T2YoXCJTY2FsZWRcIikgPCAwICYmXG4gICAgICAgICAgICAgICAgICAgIHR5cGVvZiB0aGlzLnByb3BlcnR5W2tleV0gPT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5W2tleSArIFwiU2NhbGVkXCJdID0gKHRoaXMucHJvcGVydHlba2V5XSAtIG1pbltrZXldKSAvIChtYXhba2V5XSAtIG1pbltrZXldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBtb2RpZmllcnMgPSB7XG4gICAgICAgICAgICAgICAgZGV0YWNoZWQ6IDAuOSxcbiAgICAgICAgICAgICAgICBzaXplOiAwLjYsXG4gICAgICAgICAgICAgICAgcm9vbXM6IDAuNixcbiAgICAgICAgICAgICAgICBiZWRyb29tczogMC42LFxuICAgICAgICAgICAgICAgIGVuZXJneVJhdGluZzogMC4zLFxuICAgICAgICAgICAgICAgIGdhcmFnZTogMC4zXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlxcblxcbi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cIik7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlxcbkJFR0lOTklORyBFVkFMVUFUSU9OXFxuXFxuXCIpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCItLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXFxuXFxuXCIpO1xuICAgICAgICAgICAgbGV0IGlkID0gMDtcblxuICAgICAgICAgICAgbmVhcmJ5UHJvcGVydGllcy5mb3JFYWNoKHByb3BlcnR5ID0+IHtcbiAgICAgICAgICAgICAgICAvLyBmZWF0dXJlIHNjYWxpbmdcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBrZXkgaW4gcHJvcGVydHkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5Lmhhc093blByb3BlcnR5KGtleSkgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvcGVydHkuaGFzT3duUHJvcGVydHkoa2V5KSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAga2V5LmluZGV4T2YoXCJTY2FsZWRcIikgPCAwICYmXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YgcHJvcGVydHlba2V5XSA9PSBcIm51bWJlclwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wZXJ0eVtrZXkgKyBcIlNjYWxlZFwiXSA9IChwcm9wZXJ0eVtrZXldIC0gbWluW2tleV0pIC8gKG1heFtrZXldIC0gbWluW2tleV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICBsZXQgd2VpZ2h0cyA9IHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWQ6IHByb3BlcnR5LmRldGFjaGVkID09IHRoaXMucHJvcGVydHkuZGV0YWNoZWQgPyAwIDogbW9kaWZpZXJzLmRldGFjaGVkLFxuICAgICAgICAgICAgICAgICAgICBzaXplOiBNYXRoLnNxcnQoTWF0aC5wb3cocHJvcGVydHkuc2l6ZVNjYWxlZCAtIHRoaXMucHJvcGVydHlbXCJzaXplU2NhbGVkXCJdLCAyKSkgKiBtb2RpZmllcnMuc2l6ZSxcbiAgICAgICAgICAgICAgICAgICAgcm9vbXM6IE1hdGguc3FydChNYXRoLnBvdyhwcm9wZXJ0eS5yb29tc1NjYWxlZCAtIHRoaXMucHJvcGVydHlbXCJyb29tc1NjYWxlZFwiXSwgMikpICogbW9kaWZpZXJzLnJvb21zLFxuICAgICAgICAgICAgICAgICAgICBiZWRyb29tczogTWF0aC5zcXJ0KE1hdGgucG93KHByb3BlcnR5LmJlZHJvb21zU2NhbGVkIC0gdGhpcy5wcm9wZXJ0eVtcImJlZHJvb21zU2NhbGVkXCJdLCAyKSkgKiBtb2RpZmllcnMuYmVkcm9vbXMsXG4gICAgICAgICAgICAgICAgICAgIGVuZXJneVJhdGluZzogTWF0aC5zcXJ0KE1hdGgucG93KHByb3BlcnR5LmVuZXJneVJhdGluZ1NjYWxlZCAtIHRoaXMucHJvcGVydHlbXCJlbmVyZ3lSYXRpbmdTY2FsZWRcIl0sIDIpKSAqIG1vZGlmaWVycy5lbmVyZ3lSYXRpbmcsXG4gICAgICAgICAgICAgICAgICAgIGdhcmFnZTogcHJvcGVydHkuZ2FyYWdlID09IHRoaXMucHJvcGVydHkuZ2FyYWdlID8gMCA6IG1vZGlmaWVycy5nYXJhZ2VcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gd2VpZ2h0cy5kZXRhY2hlZCArIHdlaWdodHMuc2l6ZSArIHdlaWdodHMucm9vbXMgKyB3ZWlnaHRzLmJlZHJvb21zICsgd2VpZ2h0cy5lbmVyZ3lSYXRpbmcgKyB3ZWlnaHRzLmdhcmFnZTtcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiV0VJR0hUUyAoXCIgKyBpZCsrICsgXCIpOiBcIiArIEpTT04uc3RyaW5naWZ5KHdlaWdodHMsIG51bGwsIDIpKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk9WRVJBTEwgVkFMVUU6IFwiICsgdmFsdWUgKyBcIlxcblxcblwiKTtcblxuICAgICAgICAgICAgICAgIGlmIChjbG9zZXN0ID09IG51bGwgfHwgY2xvc2VzdFZhbHVlID4gdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xvc2VzdFZhbHVlID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGNsb3Nlc3QgPSBwcm9wZXJ0eTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgbGV0IG1vbnRoRGlmZiA9IEV2YWx1YXRlQ29tcG9uZW50Lm1vbnRoRGlmZihuZXcgRGF0ZShjbG9zZXN0LnNhbGVEYXRlKSwgdGhpcy5wcm9wZXJ0eS5zYWxlRGF0ZSk7XG4gICAgICAgICAgICBsZXQgcHJpY2UgPSBjbG9zZXN0LnNhbGVQcmljZSAqIE1hdGgucG93KDEuMDMsIG1vbnRoRGlmZik7XG4gICAgICAgICAgICB0aGlzLnByb3BlcnR5LnNhbGVQcmljZSA9IHByaWNlO1xuICAgICAgICAgICAgYWxlcnQoXCJUaGUgcHJlZGljdGVkIHByaWNlIG9mIHlvdXIgcHJvcGVydHkgaXM6IFxcbiRcIiArIHByaWNlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGRpc3RhbmNlKGxvYzEsIGxvYzIpIHtcbiAgICAgICAgbGV0IGxhdDEgPSBsb2MxLmxhdGl0dWRlO1xuICAgICAgICBsZXQgbG9uMSA9IGxvYzEubG9uZ2l0dWRlO1xuICAgICAgICBsZXQgbGF0MiA9IGxvYzIubGF0aXR1ZGU7XG4gICAgICAgIGxldCBsb24yID0gbG9jMi5sb25naXR1ZGU7XG4gICAgICAgIGxldCBwID0gMC4wMTc0NTMyOTI1MTk5NDMyOTU7XG4gICAgICAgIGxldCBjID0gTWF0aC5jb3M7XG4gICAgICAgIGxldCBhID0gMC41IC0gYygobGF0MiAtIGxhdDEpICogcCkgLyAyICtcbiAgICAgICAgICAgIGMobGF0MSAqIHApICogYyhsYXQyICogcCkgKlxuICAgICAgICAgICAgKDEgLSBjKChsb24yIC0gbG9uMSkgKiBwKSkgLyAyO1xuICAgICAgICByZXR1cm4gNzkxNy41MDkyODIgKiBNYXRoLmFzaW4oTWF0aC5zcXJ0KGEpKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgbW9udGhEaWZmKGQxOiBEYXRlLCBkMjogRGF0ZSkge1xuICAgICAgICBsZXQgbW9udGhzO1xuICAgICAgICBtb250aHMgPSAoZDIuZ2V0RnVsbFllYXIoKSAtIGQxLmdldEZ1bGxZZWFyKCkpICogMTI7XG4gICAgICAgIG1vbnRocyAtPSBkMS5nZXRNb250aCgpICsgMTtcbiAgICAgICAgbW9udGhzICs9IGQyLmdldE1vbnRoKCk7XG4gICAgICAgIHJldHVybiBtb250aHMgPD0gMCA/IDAgOiBtb250aHM7XG4gICAgfVxufVxuIl19